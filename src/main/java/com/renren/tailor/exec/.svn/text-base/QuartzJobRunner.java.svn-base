package com.renren.tailor.exec;

import java.io.BufferedReader;
import java.io.InputStream;
import java.io.InputStreamReader;

import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;
import org.quartz.Job;
import org.quartz.JobDataMap;
import org.quartz.JobExecutionContext;
import org.quartz.JobExecutionException;

import com.renren.tailor.model.JobInfo;
import com.renren.tailor.util.JaskSonUtil;
import com.renren.tailor.util.ParameterUtil;

public class QuartzJobRunner implements Job {

	private static Log logger = LogFactory.getLog(QuartzJobRunner.class);

	private String partitions = "";

	@Override
	public void execute(JobExecutionContext context)
			throws JobExecutionException {
		JobDataMap map = context.getMergedJobDataMap();
		if (map.getBoolean(ParameterUtil.JOB_RUNNING)) {// 上一个作业正在运行
			return;
		}
		String[] engine = (String[]) map.get(ParameterUtil.JOB_DATA_COMMAND);
		Process process;
		int result = -1;
		try {
			process = Runtime.getRuntime().exec(engine);
			printInfo(process.getErrorStream(), 0);
			printInfo(process.getInputStream(), 1);
			result = process.waitFor();
		} catch (Exception e1) {
			e1.printStackTrace();
			logger.error("execute job error"+e1.getMessage());
			result=ParameterUtil.ErrorCode.JOBRUNNING_ERROR;
		}
		JobInfo jobInfo = JaskSonUtil.readValueAsObjFromStr(
				partitions.substring(ParameterUtil.RESULT.length()),
				JobInfo.class);
		if (jobInfo != null) {
			if (jobInfo.getResult() != 0) {
				result = jobInfo.getResult();
			} else {
				map.put(ParameterUtil.JOB_PARTITIONS, jobInfo.getPartitions());
			}
		}

		map.put(ParameterUtil.JOB_RUN_RESULT, result);
	}

	private void printInfo(InputStream inputstream, int type) {
		BufferedReader br = null;
		InputStreamReader isr = null;
		try {
			isr = new InputStreamReader(inputstream);
			br = new BufferedReader(isr);
			String line = null;
			while ((line = br.readLine()) != null) {
				if (type == 0) {
					logger.info(line);
				} else {
					if (line.startsWith(ParameterUtil.RESULT)) {
						partitions = line;
					}
				}

			}
		} catch (Exception e) {
		} finally {
			try {
				br.close();
				isr.close();
			} catch (Exception e) {
				e.printStackTrace();
			}
		}
	}

}
